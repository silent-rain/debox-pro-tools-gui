# 项目开发指南

## 系统环境

- System: ArchLinux
- Rust: v1.90.0
- Node: v24.9.0
- pnpm: 10.18.3

## 项目技术架构

### 前端技术栈

- 开发语言: JavaScript (基于 React)
- UI 框架: Ant Design (Antd)
- 构建工具: 基于 Tauri 的前端集成

### 后端技术栈

- 开发语言: Rust
- UI框架: Tauri (用于构建跨平台桌面应用)
- 数据库: Sea-Orm (基于 Rust 的 ORM 框架)

## 安装依赖

### 安装系统依赖

```sh
# 桌面端编译依赖
sudo pacman -S --needed \
  webkit2gtk-4.1 \
  base-devel \
  curl \
  wget \
  file \
  openssl \
  appmenu-gtk-module \
  libappindicator-gtk3 \
  librsvg \
  xdotool

# 链接器
sudo pacman -S --needed lld llvm

# 编译为nsis包
yay -S --needed nsis

# 运行AppImage
sudo pacman -S fuse

# Windows SDK
# 环境变量 XWIN_CACHE_DIR
cargo install cargo-xwin

# Makefile
cargo install cargo-make
```

### Java JDK

- 安装 JDK

```sh
sudo pacman -S --needed jdk17-openjdk
```

- 环境变量

```shell
# Java JDK
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk
```

### 安装 Sea-Orm Cli

```sh
cargo install sea-orm-cli
```

### 安装 Tauri

```sh
cargo install create-tauri-app

cargo install tauri-cli --version "^2.8.4"

# Tauri 环境检查
cargo tauri info 
```

### Rustup 添加编译目标

```sh
# 添加 Android 目标
rustup target add aarch64-linux-android armv7-linux-androideabi i686-linux-android x86_64-linux-android

# 添加 IOS 目标
rustup target add aarch64-apple-ios x86_64-apple-ios aarch64-apple-ios-sim
```

### 安装 Android Studio

使用 Android Studio 中的 SDK 管理器安装以下内容：

- Android SDK Platform
- Android SDK Build-Tools
- NDK (Side by side)
- Android SDK Command-line Tools
- Android SDK Platform-Tools

注意:

- Android 版本推荐: 14 (API Level 34)
- NDK 版本推荐: latest

---

- 安装

```sh
# 下载
wget https://redirector.gvt1.com/edgedl/android/studio/ide-zips/2025.1.4.8/android-studio-2025.1.4.8-linux.tar.gz

# 解压
sudo mkdir -p /opt/devSoft/
sudo tar -xvf android-studio-2025.1.4.8-linux.tar.gz -C /opt/devSoft/

ls /opt/devSoft/

# 启动 Android Studio
# 注意初始化的时候需要选择 Android SDK 的安装路径，默认安装路径为 `$HOME/Android/Sdk`, 这里调整为 `$HOME/Android/Sdk`。
/opt/devSoft/android-studio/bin/studio.sh
```

- 环境变量

```sh
# Android Studio
export ANDROID_HOME="$HOME/.Android/Sdk"
export NDK_HOME="$ANDROID_HOME/ndk/$(ls -1 $ANDROID_HOME/ndk)"
```

### 安装 Gradle

防止每个项目重复下载。

```shell
sudo wget -P /opt/devSoft/ https://services.gradle.org/distributions/gradle-8.14.3-bin.zip
```

项目中的配置本地路径

```sh
# vim src-tauri/gen/android/gradle/wrapper/gradle-wrapper.properties

# distributionUrl=https\://services.gradle.org/distributions/gradle-8.14.3-bin.zip
distributionUrl=file:///opt/devSoft/gradle-8.14.3-bin.zip
```

## 创建新项目(可选)

```sh
# 创建项目
➜  cargo create-tauri-app
✔ Project name · debox-pro-tools-gui
✔ Identifier · com.one.debox-pro-tools-gui
✔ Choose which language to use for your frontend · TypeScript / JavaScript - (pnpm, yarn, npm, deno, bun)
✔ Choose your package manager · pnpm
✔ Choose your UI template · React - (https://react.dev/)
✔ Choose your UI flavor · TypeScript

Template created! To get started run:
  cd debox-pro-tools-gui
  pnpm install
  pnpm tauri android init

For Desktop development, run:
  pnpm tauri dev

For Android development, run:
  pnpm tauri android dev
```

## 签名

### Android 签名

- [Tauri Android 签名](https://tauri.app/distribute/sign/android/)

生成签名:

```shell
keytool -genkey -v -keystore ~/upload-keystore.jks -keyalg RSA -keysize 2048 -validity 10000 -alias upload
```

引用签名

```sh
# vim apps/mobile/gen/android/keystore.properties

password=123456
keyAlias=upload
storeFile=/home/one/upload-keystore.jks
```

## 更新应用图标

```sh
# cargo tauri icon /path/to/app-icon.png

cargo tauri icon apps/mobile/assets/img/Post3.png
# 指定 iOS 图标的背景颜色
cargo tauri icon /path/to/app-icon.png --ios-color #fff
```

## 数据库迁移

```sh
# 表迁移
cd apps/crates/core/migration
cargo run -p migration -- up


# 指定数据库生成实体
cd apps/crates/core/entity

sea-orm-cli generate entity \
--database-url sqlite:///home/one/code/debox-pro-tools-gui/apps/mobile/data.dat \
--output-dir ./src \
--with-prelude all \
--with-serde both \
--entity-format dense
```

## 开发与打包

### 开发模式

初始化前端

```sh
cd mobile-web
pnpm install
```

```sh
# 桌面端调试
cargo tauri dev --no-watch

# Android 端调试
# 可能需要手动启动 Virtual Deice Manager 中的模拟器
cargo tauri android dev --no-watch
# 跳过等待前端编译
cargo tauri android dev -v --no-watch --no-dev-server-wait --host 0.0.0.0 --port 1430
```

### 打包

```sh
# DeskTop 打包
# cargo tauri build
# AppImage 打包
NO_STRIP=true cargo tauri build

# Android 打包
cargo tauri android build
# Android 打包, 指定架构编译
cargo tauri android build --apk --target aarch64 --target armv7

# Windows 打包
cargo tauri build --target x86_64-pc-windows-gnu
```

## 参考

- [Tauri](https://tauri.app/start/)
- [Tauri 配置](https://tauri.app/reference/config/)
- [Tauri 文件系统插件](https://tauri.app/plugin/file-system/)
- [React](https://react.dev/)
- [SeaORM](https://www.sea-ql.org/SeaORM/)
- [CodeBuddy 插件 Rules](https://copilot.tencent.com/docs/plugin/%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97/%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99)
